

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TDD distro development &mdash; JNRowe</title>
  

  
  
    <link rel="shortcut icon" href="../_static/icon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
        <link rel="copyright" title="Copyright" href="../copyright.html"/>
    <link rel="top" title="JNRowe" href="../index.html"/>
        <link rel="up" title="Articles" href="index.html"/>
        <link rel="next" title="Tips" href="tips/index.html"/>
        <link rel="prev" title="Introduction to RCS" href="rcs.html"/>
    <link rel="alternate" type="application/atom+xml" title="Updated items" href="/updates.atom" />

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> JNRowe
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../projects.html">Projects</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Articles</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dropping_gentoo.html">Dropping Gentoo</a></li>
<li class="toctree-l2"><a class="reference internal" href="dropping_gentoo_reflex.html">Dropping Gentoo reflex</a></li>
<li class="toctree-l2"><a class="reference internal" href="fossil.html"><strong class="command">fossil</strong> experiments</a></li>
<li class="toctree-l2"><a class="reference internal" href="mutt_config_snippets.html"><strong class="command">mutt</strong> configuration snippets</a></li>
<li class="toctree-l2"><a class="reference internal" href="rcs.html">Introduction to <abbr title="GNU Revision Control System">RCS</abbr></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#"><abbr title="Test Driven Development">TDD</abbr> distro development</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#why">Why?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how">How?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#result">Result?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bonus">Bonus</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#further-categories">Further categories</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../thoughts/index.html">Thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../colophon.html">Colophon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../consult.html">Consulting services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">Copyright information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">JNRowe</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Articles</a> &raquo;</li>
        
      <li><abbr title="Test Driven Development">TDD</abbr> distro development</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tdd-distro-development">
<h1><abbr title="Test Driven Development">TDD</abbr> distro development<a class="headerlink" href="#tdd-distro-development" title="Permalink to this headline">¶</a></h1>
<p>Using <abbr title="Test Driven Development">TDD</abbr> for distribution development is a hot topic in some of the more
geeky circles I move in, and I’m very happy about this.  Anything that
increases the robustness of my desktop computer, my phone or any other device
I use is a great goal!</p>
<div class="section" id="why">
<h2>Why?<a class="headerlink" href="#why" title="Permalink to this headline">¶</a></h2>
<p>This answer should be obvious; more testing is good.  However, what about the
current system needs improving?</p>
<p>The first point is that commonly deployed distributions base their stabilisation
processes on the lack of <em>reported</em> bugs.  This implies that packages with a
minimal set of tests(or human testers in the common case) go through much less
testing than popular packages on their way to be marked as stable.  Of course,
this also implies that bugs in popular packages that will affect many users are
often discovered before a package is stabilised.</p>
<p>The second point is that a small set of bugs are actually regressions of
previously fixed bugs.  This, by itself, is a reason to look at alternatives.
Fixing the same bug more than once is an horrendous waste of developer
resources.</p>
</div>
<div class="section" id="how">
<h2>How?<a class="headerlink" href="#how" title="Permalink to this headline">¶</a></h2>
<p>We, the fine folks of AST’s London office, already use a test-based
stabilisation policy in the preparation of our distribution images.  Adding
tests for new and bumped packages is something Leal Hétu and I have been
enforcing for the past few years.</p>
<p>Our packages and distribution images are used for the embedded devices we sell,
the desktops we develop on and the laptops we play on.  The methods we use vary
greatly, so I’m going to present the simple case of testing console applications
only.  It is the practise that is important, not the process.</p>
<p>The easiest method we use is via <a class="reference external" href="https://pypi.python.org/pypi/shelldoctest">shelldoctest</a>, a module that implements
a <a class="reference external" href="https://docs.python.org/3/library/doctest.html#module-doctest" title="(in Python v3.6)"><code class="xref py py-mod docutils literal"><span class="pre">doctest</span></code></a> interface for testing shell commands.  The package provides
a user-level script for running shell sessions in Python docstrings.  A simple
example could be:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">$ echo test</span>
<span class="sd">test</span>
<span class="sd">$ echo fail</span>
<span class="sd">liaf</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Running the previous file with <code class="docutils literal"><span class="pre">shell-doctest</span> <span class="pre">test</span> <span class="pre">testdoc.py</span></code> produces the
following output:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="go">**********************************************************************</span>
<span class="go">File &quot;testdoc.py&quot;, line 4, in testdoc</span>
<span class="go">Failed example:</span>
<span class="go">    echo fail</span>
<span class="go">Expected:</span>
<span class="go">    liaf</span>
<span class="go">Got:</span>
<span class="go">    fail</span>
<span class="go">**********************************************************************</span>
<span class="go">1 items had failures:</span>
<span class="go">   1 of   2 in testdoc</span>
<span class="go">***Test Failed*** 1 failures.</span>
</pre></div>
</div>
<p>Each time we bump a package, or add a completely new package, we also commit a
file containing a minimal series of tests that we consider important for the
package.  This allows us to almost instantly ascertain whether a future package
bump breaks functionality we require.</p>
<p>We also add a test <em>every single time</em> we fix a packaging bug, to make sure it
doesn’t come up again.  A good example can be gleaned from a bug that was fixed
in our <a class="reference external" href="http://www.vim.org/scripts/script.php?script_id=1567">rails</a> vim package.  Given the way the <a class="reference external" href="http://www.vim.org/scripts/script.php?script_id=1567">vim scripts site</a> is organised
the files you want to download have awful download locations, so our ebuild for
the <code class="docutils literal"><span class="pre">rails</span></code> plugin contains the following snippet:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">DESCRIPTION</span><span class="o">=</span><span class="s2">&quot;vim plugin: RoR - easy file navigation, enhanced syntax highlighting&quot;</span>
<span class="nv">HOMEPAGE</span><span class="o">=</span><span class="s2">&quot;http://www.vim.org/scripts/script.php?script_id=1567&quot;</span>
<span class="nv">SRC_URI</span><span class="o">=</span><span class="s2">&quot;http://www.vim.org/scripts/download_script.php?src_id=13800 -&gt; </span><span class="si">${</span><span class="nv">P</span><span class="si">}</span><span class="s2">.zip&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">SRC_URI</span></code> declaration says we need to fetch the file from
<code class="docutils literal"><span class="pre">http://www.vim.org/scripts/download_script.php?src_id=13800</span></code> and name it
locally as <code class="file docutils literal"><span class="pre">rails-4.3.zip</span></code>.  I’m sure you can guess what happened here,
someone saved a copy of the file locally for testing and forgot to update the
<code class="docutils literal"><span class="pre">src_id</span></code> parameter correctly<a class="footnote-reference brackets" href="#id2" id="id1">1</a>.  The result was an apparently new build
that installed an older package release.</p>
<p>When a fix for this bug was committed a test similar to the following snippet
was added to the <code class="docutils literal"><span class="pre">rails</span></code> test suite:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">$ grep -l &quot;autoloaded_rails = &#39;${PV}&#39;&quot; /usr/share/vim/vimfiles/autoload/rails.vim</span>
<span class="sd">/usr/share/vim/vimfiles/autoload/rails.vim</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>All this does is check the reported version is correct, and it clearly only took
a few seconds to write.  This is important, it shouldn’t cost a lot to write a
test and this is especially true for the simplest task.</p>
<p>I use a similar technique for managing my public Gentoo overlay, <a class="reference external" href="https://github.com/JNRowe/jnrowe-misc">jnrowe-misc</a>.
For example, the <a class="reference external" href="https://pypi.python.org/pypi/blockdiag">blockdiag</a> ebuild is accompanied by a series of tests
that are run when bumping or stabilising the package, all of which are cribbed
from my actual <code class="docutils literal"><span class="pre">blockdiag</span></code> usage.  This massively reduces the time required
to evaluate a package at bump time.</p>
</div>
<div class="section" id="result">
<h2>Result?<a class="headerlink" href="#result" title="Permalink to this headline">¶</a></h2>
<p>The time it takes to stabilise, or bump, a package may be massively reduced
while simultaneously increasing the robustness of the packages.  This is a huge
win, much bigger than we initially envisaged.</p>
<p>We still use time-based stabilisation, but in union with test-based
stabilisation.  It means that on the time-based stabilisation date we can
conveniently script the progression to stable including a final run of the test
suite.</p>
<p>I would, of course, prefer to see <em>any</em> tests upstreamed and where possible this
is already happening.  However, we’re pragmatists and this means we often use
existing content as input for tests.  The use of existing input makes writing
the test faster and means each test exercises functionality we actually require,
but it also means we occasionally can’t submit the data upstream owing to
licensing concerns.</p>
</div>
<div class="section" id="bonus">
<h2>Bonus<a class="headerlink" href="#bonus" title="Permalink to this headline">¶</a></h2>
<p>I’ve used the upstream supported <code class="docutils literal"><span class="pre">shelldoctest</span></code> method for writing tests on
this page, but you can also easily specify them in <a class="reference external" href="http://docutils.sourceforge.net/docs/user/rst/">reST syntax</a> files too.
Doing this encourages you to write nicely formatted documentation to accompany
your tests.  You can also leverage your tests that are written in this way as
documentation using the excellent <a class="reference external" href="http://sphinx-doc.org/">Sphinx</a> tool.</p>
<p>The following script shows an extremely basic, yet fully functional, example of
how to combine the <a class="reference external" href="https://docs.python.org/3/library/doctest.html#module-doctest" title="(in Python v3.6)"><code class="xref py py-mod docutils literal"><span class="pre">doctest</span></code></a> module’s <a class="reference external" href="https://docs.python.org/3/library/doctest.html#doctest.testfile" title="(in Python v3.6)"><code class="xref py py-func docutils literal"><span class="pre">testfile()</span></code></a> function
with <code class="docutils literal"><span class="pre">shelldoctest</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python -tt</span>
<span class="kn">import</span> <span class="nn">doctest</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">shelldoctest</span> <span class="kn">as</span> <span class="nn">sd</span>

<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">doctest</span><span class="o">.</span><span class="n">testfile</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">module_relative</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">extraglobs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;system_command&quot;</span><span class="p">:</span> <span class="n">sd</span><span class="o">.</span><span class="n">system_command</span><span class="p">},</span>
                          <span class="n">parser</span><span class="o">=</span><span class="n">sd</span><span class="o">.</span><span class="n">ShellDocTestParser</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>This script parses the first argument on the command line when it is run and
executes any <code class="docutils literal"><span class="pre">shelldoctest</span></code> blocks it finds.  It returns the count of failed
tests as its exit code, helpfully allowing you to execute a command with <code class="docutils literal"><span class="pre">&amp;&amp;</span></code>
if all the tests pass.</p>
<p>We operate this way at AST, the above <code class="docutils literal"><span class="pre">rails</span></code> test would actually be part of
a <code class="docutils literal"><span class="pre">reST</span></code> formatted file as follows:</p>
<div class="highlight-rst"><div class="highlight"><pre><span></span>Fix bug #xx, incorrect archive file<span class="se">::</span>

<span class="s">    $ grep -l &quot;autoloaded_rails = &#39;${PV}&#39;&quot; /usr/share/vim/vimfiles/autoload/rails.vim</span>
<span class="s">    /usr/share/vim/vimfiles/autoload/rails.vim</span>
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Okay, it was me.  I’ll confess.</p>
</dd>
</dl>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tips/index.html" class="btn btn-neutral float-right" title="Tips" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="rcs.html" class="btn btn-neutral" title="Introduction to RCS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="../copyright.html">Copyright</a> 2009-2018  James Rowe.
      Last updated on &#39;2018-01-23 [6f0c07b]&#39;.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  false,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>