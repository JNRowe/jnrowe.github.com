<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Bugzilla mail with real names &mdash; JNRowe</title>
    
    <link rel="stylesheet" href="../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/icon.ico"/>
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="JNRowe" href="../../index.html" />
    <link rel="up" title="Tips" href="index.html" />
    <link rel="next" title="Compiling C source in vim" href="Compiling_in_vim.html" />
    <link rel="prev" title="Beyond simple tab completion" href="Beyond_tab_completion.html" />
    <link rel="alternate" type="application/atom+xml" title="Updated items" href="/updates.atom" />
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
          <p class="logo"><a href="../../index.html">
            <img class="logo" src="../../_static/logo.png" alt="Logo"/>
          </a></p>
        <div class="headertitle"><a
          href="../../index.html">JNRowe</a></div>
        <div class="rel">
          <a href="Beyond_tab_completion.html" title="Beyond simple tab completion"
             accesskey="P">previous</a> |
          <a href="Compiling_in_vim.html" title="Compiling C source in vim"
             accesskey="N">next</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
    <div class="admonition note">
        <p class="first admonition-title">
            Estimated reading time: 4 minutes
        </p>
    </div>
    
    
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="bugzilla-mail-with-real-names">
<h1>Bugzilla mail with real names<a class="headerlink" href="#bugzilla-mail-with-real-names" title="Permalink to this headline">Â¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">date:</th><td class="field-body">2009-09-27</td>
</tr>
</tbody>
</table>
<p>John Bateman rants on the EADS Linux list:</p>
<blockquote>
<div><a class="reference external" href="http://www.bugzilla.org">Bugzilla</a> annoys the hell out of me, why I can&#8217;t just choose &#8220;spoof From
address&#8221; in bugspam is beyond me.  It makes filtering such a chore!!</div></blockquote>
<p>I agree, and I&#8217;ve long since decided to fix the problem locally.  There are
unfortunately a couple of small prerequisites for using my method that you may
not have.  The first is that you need to be able to filter the content of the
mail easily, and the second is that you install
<a class="reference external" href="http://www.spinnaker.de/lbdb/">lbdb</a>.</p>
<p><tt class="docutils literal"><span class="pre">lbdb</span></tt> is a small tool designed for handling mail addresses in <a class="reference external" href="http://www.mutt.org">mutt</a>, but it
does not require you to use or even install mutt.  What we are going to do is
use <tt class="docutils literal"><span class="pre">lbdb</span></tt> and our own incoming mail to seed an email-to-name database for our
bugspam filtering.  We don&#8217;t even need to configure lbdb to use it for our
purposes, although I do recommend giving the package a try even if you use
another mail client.</p>
<p>The <tt class="docutils literal"><span class="pre">lbdb</span></tt> tool we want to use is <tt class="docutils literal"><span class="pre">lbdb-fetchaddr</span></tt> which is designed to
generate an address search database for the <tt class="docutils literal"><span class="pre">lbdb</span></tt> <tt class="docutils literal"><span class="pre">m_inmail</span></tt> method.
<tt class="docutils literal"><span class="pre">lbdb-fetchaddr</span></tt> keeps a text database of all the names, addresses and the
last seen date of every address we pass through it.  This allows our Bugzilla
filter to work without us having to generate our own email-to-name list assuming
we receive mail from the bug commenter either personally or on a list, at the
cost of increased(albeit still negligible) processing time.  I use <a class="reference external" href="http://www.courier-mta.org/maildrop/">maildrop</a> to
filter my mail and to tell the <tt class="docutils literal"><span class="pre">maildrop</span></tt> <abbr title="Mail Delivery Agent">MDA</abbr> to
update the <tt class="docutils literal"><span class="pre">lbdb</span></tt> database we add a simple rule to our <tt class="docutils literal"><span class="pre">~/.mailfilter</span></tt>:</p>
<div class="highlight-text"><div class="highlight"><pre>if ($SIZE &lt; 32768)
    cc &#39;| lbdb-fetchaddr -d &quot;%FT%T%z&quot;&#39;
</pre></div>
</div>
<p><a class="reference external" href="http://gist.github.com/198021">Fork this code</a></p>
<p>This tells <tt class="docutils literal"><span class="pre">maildrop</span></tt> to pass all mails less than 32k in size through
<tt class="docutils literal"><span class="pre">lbdq-fetchaddr</span></tt>, and we specify a nice ISO-8601 time format for easy sorting
and parsing should the need arise.  Now every mail that is delivered with
<tt class="docutils literal"><span class="pre">maildrop</span></tt> and isn&#8217;t too large will have the sender name and address recorded
in <tt class="docutils literal"><span class="pre">~/.lbdb/m_inmail.list</span></tt>.</p>
<p>Now on to the actual filtering script, which is is written in <a class="reference external" href="http://www.python.org/">Python</a>.  It only
uses modules from the Python standard library, so you don&#8217;t need to install
anything else.  I have tested it with
25000 unique entries in <tt class="docutils literal"><span class="pre">~/.lbdb/m_inmail.list</span></tt> and it still takes less than
a thirtieth of a second to run the filter on my desktop, so processing the
database each time we start up isn&#8217;t really an issue.  Also, the few small tests
I&#8217;ve done suggest that using &#8220;real&#8221; database engines doesn&#8217;t help and the only
way to speed it up significantly would be to write a small daemon to process the
mail which seems more than a little overkill to me.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#! /usr/bin/python -tt</span>

<span class="kn">from</span> <span class="nn">csv</span> <span class="kn">import</span> <span class="n">reader</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">message_from_file</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">expanduser</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdin</span>

<span class="n">lbdb</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&quot;~/.lbdb/m_inmail.list&quot;</span><span class="p">)),</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">addresses</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rec</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">lbdb</span><span class="p">)</span>

<span class="n">message</span> <span class="o">=</span> <span class="n">message_from_file</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>

<span class="n">commenter</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot; changed:&quot;</span><span class="p">):</span>
        <span class="n">commenter</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">break</span>
    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;------- Comment #&quot;</span><span class="p">):</span>
        <span class="n">commenter</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">break</span>
    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;        ReportedBy: &quot;</span><span class="p">):</span>
        <span class="n">commenter</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">break</span>

<span class="c"># You could also filter the message content at this point if you wished.</span>
<span class="c"># The following, for example, would remove the &quot;https&quot; link and some of</span>
<span class="c"># the blank lines in Gentoo bugspam</span>
<span class="n">message</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">3</span><span class="p">],</span> <span class="p">]</span>
                            <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">6</span><span class="p">:]))</span>

<span class="k">if</span> <span class="n">commenter</span> <span class="ow">in</span> <span class="n">addresses</span><span class="p">:</span>
    <span class="n">message</span><span class="o">.</span><span class="n">replace_header</span><span class="p">(</span><span class="s">&quot;from&quot;</span><span class="p">,</span>
                        <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; &lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">addresses</span><span class="p">[</span><span class="n">commenter</span><span class="p">],</span> <span class="n">commenter</span><span class="p">))</span>

<span class="k">print</span> <span class="n">message</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference external" href="http://gist.github.com/198022">Fork this code</a></p>
<p>The final addition to our <tt class="docutils literal"><span class="pre">~/.mailfilter</span></tt> file enables our little Python
filter to process mail from Bugzilla and change its <tt class="docutils literal"><span class="pre">from</span></tt> address if we have
the information in the <tt class="docutils literal"><span class="pre">~/.lbdb/m_inmail.list</span></tt> database.</p>
<div class="highlight-text"><div class="highlight"><pre>if (/^From: bugzilla-daemon@/)
{
    xfilter &quot;~/.mailfilter.d/rewrite-name.py&quot;
    to Mail/Gentoo-bugs
}
</pre></div>
</div>
<p><a class="reference external" href="http://gist.github.com/198023">Fork this code</a></p>
<p>And from now on, or at least once your <tt class="docutils literal"><span class="pre">m_inmail.list</span></tt> is sufficiently seeded,
your bugspam will have the commenter&#8217;s name and email address, making it much
easier to filter and process it in your favourite mail client.</p>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../projects.html">Projects</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Articles</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rcs.html">Introduction to RCS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tdd_distros.html">TDD distro development</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../thoughts/index.html">Thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../colophon.html">Colophon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../consult.html">Consulting services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright information</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="../../search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="Beyond_tab_completion.html" title="Beyond simple tab completion"
             >previous</a> |
          <a href="Compiling_in_vim.html" title="Compiling C source in vim"
             >next</a> |
          <a href="../../genindex.html" title="General Index"
             >index</a>
            <br/>
            <a href="../../_sources/articles/tips/Bugzilla_real_names.txt"
               rel="nofollow">Show Source</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; <a href="../../copyright.html">Copyright</a> 2009-2014, James Rowe.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>