

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Bugzilla mail with real names &mdash; JNRowe</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/icon.ico"/>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
        <link rel="copyright" title="Copyright" href="../../copyright.html"/>
    <link rel="top" title="JNRowe" href="../../index.html"/>
        <link rel="up" title="Tips" href="index.html"/>
        <link rel="next" title="Compiling C source in vim" href="Compiling_in_vim.html"/>
        <link rel="prev" title="Beyond simple tab completion" href="Beyond_tab_completion.html"/>
    <link rel="alternate" type="application/atom+xml" title="Updated items" href="/updates.atom" />

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> JNRowe</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../projects.html">Projects</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../projects.html#forks-i-m-hacking-on">Forks I&#8217;m hacking on</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects.html#git-mirrors-of-projects-i-m-hacking-on">Git mirrors of projects I&#8217;m hacking on</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Articles</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../dropping_gentoo.html">Dropping Gentoo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dropping_gentoo_reflex.html">Dropping Gentoo reflex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fossil.html"><tt class="docutils literal"><span class="pre">fossil</span></tt> experiments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rcs.html">Introduction to RCS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tdd_distros.html">TDD distro development</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#further-categories">Further categories</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../thoughts/index.html">Thoughts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/burn_out.html">Open Source and enjoyment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/burn_out.html#the-solutions">The solutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/delayed_flashover.html">Delayed flashover</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/disconnect.html">Cleanse thy soul</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/dopplr_effects.html">Dopplr defects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/important_balance.html">Murdering morality with ferocious fire</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/nice_stories.html">Tell me a nice story, please</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/reset_in_ten.html">Hitting life&#8217;s reset button</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/side_projects.html">Side-projects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thoughts/the_returned.html">Return to rambling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../colophon.html">Colophon</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../colophon.html#content-creation">Content creation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../colophon.html#and-finally">And finally...</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../consult.html">Consulting services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright information</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">JNRowe</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Articles</a> &raquo;</li>
      
          <li><a href="index.html">Tips</a> &raquo;</li>
      
    <li>Bugzilla mail with real names</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/articles/tips/Bugzilla_real_names.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
    <div class="admonition note">
        <p class="first admonition-title">
            Estimated reading time: 1 minutes
        </p>
    </div>
    
    
            
  <div class="section" id="bugzilla-mail-with-real-names">
<h1>Bugzilla mail with real names<a class="headerlink" href="#bugzilla-mail-with-real-names" title="Permalink to this headline">Â¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">date:</th><td class="field-body">2009-09-27</td>
</tr>
</tbody>
</table>
<p>John Bateman rants on the EADS Linux list:</p>
<blockquote>
<div><a class="reference external" href="http://www.bugzilla.org">Bugzilla</a> annoys the hell out of me, why I can&#8217;t just choose &#8220;spoof From
address&#8221; in bugspam is beyond me.  It makes filtering such a chore!!</div></blockquote>
<p>I agree, and I&#8217;ve long since decided to fix the problem locally.  There are
unfortunately a couple of small prerequisites for using my method that you may
not have.  The first is that you need to be able to filter the content of the
mail easily, and the second is that you install
<a class="reference external" href="http://www.spinnaker.de/lbdb/">lbdb</a>.</p>
<p><tt class="docutils literal"><span class="pre">lbdb</span></tt> is a small tool designed for handling mail addresses in <a class="reference external" href="http://www.mutt.org">mutt</a>, but it
does not require you to use or even install mutt.  What we are going to do is
use <tt class="docutils literal"><span class="pre">lbdb</span></tt> and our own incoming mail to seed an email-to-name database for our
bugspam filtering.  We don&#8217;t even need to configure lbdb to use it for our
purposes, although I do recommend giving the package a try even if you use
another mail client.</p>
<p>The <tt class="docutils literal"><span class="pre">lbdb</span></tt> tool we want to use is <tt class="docutils literal"><span class="pre">lbdb-fetchaddr</span></tt> which is designed to
generate an address search database for the <tt class="docutils literal"><span class="pre">lbdb</span></tt> <tt class="docutils literal"><span class="pre">m_inmail</span></tt> method.
<tt class="docutils literal"><span class="pre">lbdb-fetchaddr</span></tt> keeps a text database of all the names, addresses and the
last seen date of every address we pass through it.  This allows our Bugzilla
filter to work without us having to generate our own email-to-name list assuming
we receive mail from the bug commenter either personally or on a list, at the
cost of increased(albeit still negligible) processing time.  I use <a class="reference external" href="http://www.courier-mta.org/maildrop/">maildrop</a> to
filter my mail and to tell the <tt class="docutils literal"><span class="pre">maildrop</span></tt> <abbr title="Mail Delivery Agent">MDA</abbr> to
update the <tt class="docutils literal"><span class="pre">lbdb</span></tt> database we add a simple rule to our <tt class="docutils literal"><span class="pre">~/.mailfilter</span></tt>:</p>
<div class="highlight-text"><div class="highlight"><pre>if ($SIZE &lt; 32768)
    cc &#39;| lbdb-fetchaddr -d &quot;%FT%T%z&quot;&#39;
</pre></div>
</div>
<p><a class="reference external" href="http://gist.github.com/198021">Fork this code</a></p>
<p>This tells <tt class="docutils literal"><span class="pre">maildrop</span></tt> to pass all mails less than 32k in size through
<tt class="docutils literal"><span class="pre">lbdq-fetchaddr</span></tt>, and we specify a nice ISO-8601 time format for easy sorting
and parsing should the need arise.  Now every mail that is delivered with
<tt class="docutils literal"><span class="pre">maildrop</span></tt> and isn&#8217;t too large will have the sender name and address recorded
in <tt class="docutils literal"><span class="pre">~/.lbdb/m_inmail.list</span></tt>.</p>
<p>Now on to the actual filtering script, which is is written in <a class="reference external" href="http://www.python.org/">Python</a>.  It only
uses modules from the Python standard library, so you don&#8217;t need to install
anything else.  I have tested it with
25000 unique entries in <tt class="docutils literal"><span class="pre">~/.lbdb/m_inmail.list</span></tt> and it still takes less than
a thirtieth of a second to run the filter on my desktop, so processing the
database each time we start up isn&#8217;t really an issue.  Also, the few small tests
I&#8217;ve done suggest that using &#8220;real&#8221; database engines doesn&#8217;t help and the only
way to speed it up significantly would be to write a small daemon to process the
mail which seems more than a little overkill to me.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#! /usr/bin/python -tt</span>

<span class="kn">from</span> <span class="nn">csv</span> <span class="kn">import</span> <span class="n">reader</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">message_from_file</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">expanduser</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdin</span>

<span class="n">lbdb</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&quot;~/.lbdb/m_inmail.list&quot;</span><span class="p">)),</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">addresses</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rec</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">lbdb</span><span class="p">)</span>

<span class="n">message</span> <span class="o">=</span> <span class="n">message_from_file</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>

<span class="n">commenter</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot; changed:&quot;</span><span class="p">):</span>
        <span class="n">commenter</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">break</span>
    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;------- Comment #&quot;</span><span class="p">):</span>
        <span class="n">commenter</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">break</span>
    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;        ReportedBy: &quot;</span><span class="p">):</span>
        <span class="n">commenter</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">break</span>

<span class="c"># You could also filter the message content at this point if you wished.</span>
<span class="c"># The following, for example, would remove the &quot;https&quot; link and some of</span>
<span class="c"># the blank lines in Gentoo bugspam</span>
<span class="n">message</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">3</span><span class="p">],</span> <span class="p">]</span>
                            <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">6</span><span class="p">:]))</span>

<span class="k">if</span> <span class="n">commenter</span> <span class="ow">in</span> <span class="n">addresses</span><span class="p">:</span>
    <span class="n">message</span><span class="o">.</span><span class="n">replace_header</span><span class="p">(</span><span class="s">&quot;from&quot;</span><span class="p">,</span>
                        <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; &lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">addresses</span><span class="p">[</span><span class="n">commenter</span><span class="p">],</span> <span class="n">commenter</span><span class="p">))</span>

<span class="k">print</span> <span class="n">message</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference external" href="http://gist.github.com/198022">Fork this code</a></p>
<p>The final addition to our <tt class="docutils literal"><span class="pre">~/.mailfilter</span></tt> file enables our little Python
filter to process mail from Bugzilla and change its <tt class="docutils literal"><span class="pre">from</span></tt> address if we have
the information in the <tt class="docutils literal"><span class="pre">~/.lbdb/m_inmail.list</span></tt> database.</p>
<div class="highlight-text"><div class="highlight"><pre>if (/^From: bugzilla-daemon@/)
{
    xfilter &quot;~/.mailfilter.d/rewrite-name.py&quot;
    to Mail/Gentoo-bugs
}
</pre></div>
</div>
<p><a class="reference external" href="http://gist.github.com/198023">Fork this code</a></p>
<p>And from now on, or at least once your <tt class="docutils literal"><span class="pre">m_inmail.list</span></tt> is sufficiently seeded,
your bugspam will have the commenter&#8217;s name and email address, making it much
easier to filter and process it in your favourite mail client.</p>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Compiling_in_vim.html" class="btn btn-neutral float-right" title="Compiling C source in vim"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Beyond_tab_completion.html" class="btn btn-neutral" title="Beyond simple tab completion"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="../../copyright.html">Copyright</a> 2009-2014, James Rowe.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>